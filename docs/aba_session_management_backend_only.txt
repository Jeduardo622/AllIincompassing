# ABA Session Management (Backend Reference)

This guide documents the **actual** Supabase schema, helper functions, and RLS policies that protect ABA session data in this repository. It replaces the earlier theoretical outline with references to the migrations and runtime helpers we maintain today.

---

## 1. Core Multi-Tenant Schema

- **Organization-scoped tables** – Therapists, clients, sessions, and billing records all include a non-null `organization_id`. The `20251021121500_enforce_org_not_null.sql` migration backfills any missing orgs and enforces `NOT NULL` across those tables so every record is anchored to a single clinic.【11:51:supabase/migrations/20251021121500_enforce_org_not_null.sql】
- **Scheduling data** – `public.sessions` stores the therapist/client pair, duration, status, and notes. The `20251111130000_therapist_sessions_enforcement.sql` migration adds a `sessions_no_overlap` exclusion constraint (preventing double-booking), reinstates org-scoped indexes, and introduces `session_audit_logs` for immutable event history.【4:44:supabase/migrations/20251111130000_therapist_sessions_enforcement.sql】
- **Auxiliary tables** – `session_holds`, `session_audit_logs`, and `client_guardians` all carry org references so RLS can continue to reason about tenancy when therapists place holds, edit notes, or invite guardians.【4:115:supabase/migrations/20251225150000_session_holds_org_scope.sql】【227:358:supabase/migrations/20251226090000_client_guardians.sql】

---

## 2. Access Helpers & Identity Primitives

- `app.current_user_id()` and `app.current_user_organization_id()` expose the caller’s identity and org claim to SQL policies, while `app.user_has_role_for_org(...)` maps aliases such as `org_admin`/`org_member` to concrete role checks. All three live in `20251223131500_align_rls_and_grants.sql` and remove the need for ad-hoc joins inside policies.【11:114:supabase/migrations/20251223131500_align_rls_and_grants.sql】
- `app.current_therapist_id()`, `app.can_access_session(session_id)`, and `app.can_access_client(client_id)` determine whether the caller is an admin, assigned therapist, client, or guardian before any RLS predicate grants access. These helpers are defined in `20251118120000_restore_access_helpers.sql` and are reused everywhere from sessions to guardian portals.【7:155:supabase/migrations/20251118120000_restore_access_helpers.sql】

---

## 3. Row-Level Security & Role Enforcement

- **Sessions** – Three layered policies guard `public.sessions`:
  - `sessions_scoped_access` allows `SELECT` for admins, callers who satisfy `app.can_access_session`, or members of the same org via `app.user_has_role_for_org`.
  - `sessions_admin_manage` restricts inserts/updates/deletes to org admins or super-admins.
  - `sessions_therapist_note_update` lets the assigned therapist update status/notes on their own sessions without elevating broader privileges.【217:270:supabase/migrations/20251111130000_therapist_sessions_enforcement.sql】
- **Clients & therapists** – Equivalent policies (`role_scoped_select`, `clients_admin_manage`, etc.) combine `app.is_admin()`, `app.can_access_client`, and organization-role checks to guarantee that reads/writes never cross tenant boundaries.【146:214:supabase/migrations/20251111130000_therapist_sessions_enforcement.sql】
- **Guardians** – The overloaded helper `app.user_has_role_for_org('client', org_id, NULL, client_id)` (from `20251226090000_client_guardians.sql`) powers RLS so caregivers can see their child’s sessions/notes while remaining limited to that child’s organization.【227:358:supabase/migrations/20251226090000_client_guardians.sql】

---

## 4. Scheduling, Holds, and Attendance

- **Conflict prevention** – The `sessions_no_overlap` exclusion constraint and org-aware indexes prevent double-booking a therapist and ensure lookups stay performant even as volume grows.【4:23:supabase/migrations/20251111130000_therapist_sessions_enforcement.sql】
- **Session holds** – `app.set_session_hold_organization()` keeps every hold row synced to the therapist’s org, and the `"Session holds scoped access"` policies limit view/update permissions to the therapist or clinic admins.【4:115:supabase/migrations/20251225150000_session_holds_org_scope.sql】
- **Attendance workflow** – Therapists change their own sessions via `sessions_therapist_note_update`, while admins use `sessions_admin_manage` to handle cross-team adjustments (e.g., marking cancellations or resolving conflicts).

---

## 5. Auditing & PHI Controls

- **Automatic note history** – `session_audit_logs` plus `app.record_session_audit` capture each note edit (actor, org, therapist, JSON payload). The `log_session_note_update` trigger fires automatically whenever `public.sessions.notes` changes, giving the team an immutable HIPAA-friendly audit trail.【24:144:supabase/migrations/20251111130000_therapist_sessions_enforcement.sql】
- **Least-privilege reads** – Audit rows inherit the same `organization_id` and reference `app.can_access_session`, so only admins or parties who could see the underlying session can view PHI-rich audit payloads.
- **Storage considerations** – Keep PHI out of logs and public buckets. Use Supabase Storage’s private buckets + signed URLs and gate downloads with the same helpers if therapists upload attachments.

---

## 6. Compliance & Operational Checklist

1. **Legal posture** – Sign Supabase’s BAA (Enterprise plan) and mark the project HIPAA-compliant before storing PHI.
2. **Operational safeguards** – Enforce MFA for admins, restrict database ingress via network policies, enable PITR backups, and monitor Supabase advisors for new findings.
3. **Access reviews** – Update `user_roles` when staff changes occur so `app.user_has_role_for_org` immediately revokes access across all policies.
4. **Alerting** – Combine Supabase query logs with application telemetry (e.g., route guard traces) to detect unusual access patterns or potential breaches.

Keeping these migrations, helpers, and operational practices in sync ensures every ABA session, note, hold, and guardian interaction stays inside its organization boundary while meeting HIPAA/CMIA expectations.

