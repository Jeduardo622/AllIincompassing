import{r as k,n as te,j as e,M as $,L as Q,a as ae,X as re,l as ne,o as oe,c as F,U as H,e as ie,p as le,q as ce,s as me,t as de,v as ue,F as G,C as pe,B as he,w as be,x as fe,y as ge,G as Ne,H as xe,I as ye,J as ve}from"./vendor-CkTWaQD2.js";import{b as ee,L as ke,c as Ce,O as De}from"./router-BMrycgU4.js";import{l as x,b as W,c as B,d as we,u as K,s as q,f as I,a as E}from"./reports-B0fjwS8-.js";import{u as Ae}from"./App-iIKrEW6E.js";import{c as Ie}from"./sessionCancellation-Cpqlzbyp.js";import"./maps-DwSjqVUD.js";import"./supabase-BgfCgt6W.js";import"./dates-C30WUoI7.js";class T extends Error{audit;constructor(s,i){super(s),this.name="AssistantGuardrailError",this.audit=i}}const X=4e3,Ee=/[\p{C}]/gu,J=["client","therapist","admin","super_admin"],Se={client:[],therapist:["schedule_session","modify_session","cancel_sessions"],admin:["schedule_session","modify_session","cancel_sessions","create_client","update_client","create_authorization","update_authorization","initiate_client_onboarding"],super_admin:["schedule_session","modify_session","cancel_sessions","create_client","update_client","create_authorization","update_authorization","initiate_client_onboarding","create_therapist","update_therapist"]},O=new Map,_e=[{pattern:/ignore (?:all|the) previous instructions/i,reason:"prompt_blocked",description:"prompt_injection"},{pattern:/export (?:all )?(?:client|patient) data/i,reason:"prompt_blocked",description:"data_exfiltration"},{pattern:/\b(?:drop|truncate)\s+(?:table|schema)/i,reason:"prompt_blocked",description:"sql_injection"},{pattern:/\b(?:disable|bypass)\s+(?:guardrail|safety)/i,reason:"prompt_blocked",description:"guardrail_bypass"},{pattern:/\bssn\b|social security number/i,reason:"prompt_blocked",description:"phi_exfiltration"}],Y=n=>n.length>120?`${n.slice(0,117)}...`:n,Ue=n=>{const i=n.replace(Ee," ").replace(/[ \t]+/g," ").replace(/\s{2,}/g," ").trim();return i?i.length>X?{sanitized:i.slice(0,X),truncated:!0}:{sanitized:i,truncated:!1}:{sanitized:"",truncated:!1}},se=n=>{if(O.has(n))return O.get(n)??[];const s=J.indexOf(n);if(s===-1)return O.set(n,[]),[];const i=new Set;for(let p=0;p<=s;p+=1){const c=J[p];(Se[c]??[]).forEach(m=>i.add(m))}const t=Array.from(i.values());return O.set(n,t),t},je=(n,s)=>{const i=new Set(se(n.role)),t=s??n.allowedTools??Array.from(i.values()),p=Array.from(new Set(t)),c=[],h=[];return p.forEach(m=>{i.has(m)?c.push(m):h.push(m)}),c.length===0&&h.length===0&&c.push(...i.values()),{allowed:c,denied:h}},Ve=n=>{const s=n.actor??null;if(!s||!s.id||!s.role){const m={actorId:s?.id??"unknown",role:s?.role??"client",timestamp:new Date().toISOString(),reason:"invalid_message",allowedTools:[],deniedTools:[],messagePreview:"",metadata:n.metadata};throw new T("Unable to verify assistant permissions for this request",m)}const i=Ue(n.message);if(!i.sanitized){const m={actorId:s.id,role:s.role,timestamp:new Date().toISOString(),reason:"invalid_message",allowedTools:[],deniedTools:[],messagePreview:"",truncated:i.truncated,metadata:n.metadata};throw x.warn("AI guardrail rejected empty or invalid message",{metadata:m}),new T("Assistant prompt rejected by guardrails",m)}const t=_e.find(({pattern:m})=>m.test(i.sanitized));if(t){const m={actorId:s.id,role:s.role,timestamp:new Date().toISOString(),reason:t.reason,allowedTools:[],deniedTools:[],messagePreview:Y(i.sanitized),truncated:i.truncated,metadata:{...n.metadata,violation:t.description}};throw x.warn("AI guardrail blocked high-risk prompt",{metadata:m}),new T("Assistant prompt violates safety guardrails",m)}const{allowed:p,denied:c}=je(s,n.requestedTools),h={actorId:s.id,role:s.role,timestamp:new Date().toISOString(),reason:c.length>0?"tool_denied":"approved",allowedTools:p,deniedTools:c,messagePreview:Y(i.sanitized),truncated:i.truncated,metadata:n.metadata};if(c.length>0)throw x.warn("AI guardrail denied tool permissions for request",{metadata:h}),new T("Assistant tools not permitted for current role",h);return x.info("AI guardrail approved assistant request",{metadata:h}),{sanitizedMessage:i.sanitized,allowedTools:p,auditTrail:h}},Be=n=>{const s=n?.accessToken;if(!s||typeof s!="string"||s.trim().length===0)throw new Error("Missing Supabase access token for edge function request");return s},Z=(n,s)=>{const i=Be(s);return{method:"POST",headers:{"Content-Type":"application/json",apikey:we(),Authorization:`Bearer ${i}`},body:JSON.stringify(n)}};async function Te(n,s,i){const t=Ve({message:n,actor:s.actor,requestedTools:s.requestedTools,metadata:{url:s.url,userAgent:s.userAgent,conversationId:s.conversationId}}),p={message:t.sanitizedMessage,context:{url:s.url,userAgent:s.userAgent,conversationId:s.conversationId,actor:s.actor,guardrails:{allowedTools:t.allowedTools,audit:t.auditTrail}}};try{const c=W("ai-agent-optimized"),h=await fetch(c,Z(p,i));if(!h.ok){console.warn(`Optimized AI agent failed with status: ${h.status}, falling back to process-message`);const S=W("process-message"),g=await fetch(S,Z(p,i));if(!g.ok)throw new Error(`HTTP error! status: ${g.status}`);return await g.json()}return await h.json()}catch(c){if(c instanceof T)throw c;return console.error("Error processing message:",c),c instanceof Error&&(console.error("Error details:",c.stack),B.trackAIError(c,{functionCalled:"processMessage",errorType:"network_error"})),{response:"I apologize, but I'm having trouble processing your request right now. Please try again in a moment or use the manual interface instead.",responseTime:0,error:c instanceof Error?c.message:"Unknown error"}}}function ze(){const[n,s]=k.useState(!1),[i,t]=k.useState([]),[p,c]=k.useState(""),[h,m]=k.useState(!1),[S,g]=k.useState(null),A=k.useRef(null),[U,j]=k.useState(null),C=te(),M=ee(),{session:D,profile:z}=K();k.useEffect(()=>{const N=localStorage.getItem("chatConversationId");N&&(j(N),x.debug("Loaded chat conversation identifier from storage"))},[]);const R=()=>{A.current?.scrollIntoView({behavior:"smooth"})};k.useEffect(()=>{R()},[i]);const L=async N=>{if(N.preventDefault(),!p.trim()||h)return;const _=p.trim();c(""),g(null),t(u=>[...u,{role:"user",content:_,status:"complete"}]);try{if(!D?.access_token||!D.user?.id){const b=new Error("Active session is required to call edge functions");B.trackAIError(b,{functionCalled:"ChatBot_processMessage",errorType:"auth_error"}),t(r=>[...r,{role:"assistant",content:"Please sign in to use the assistant.",status:"error"}]),g("Authentication required"),q("Please sign in to use the assistant.");return}if(!z){const b=new Error("Active profile is required to use the assistant");B.trackAIError(b,{functionCalled:"ChatBot_processMessage",errorType:"auth_error"}),t(r=>[...r,{role:"assistant",content:"We could not confirm your permissions for the assistant. Please refresh and try again.",status:"error"}]),g("Unable to verify your permissions. Please refresh the page and try again."),q("Unable to verify your permissions. Please refresh the page and try again.");return}t(b=>[...b,{role:"assistant",content:"Thinking...",status:"sending"}]),m(!0);const u=se(z.role),a=await Te(_,{url:window.location.href,userAgent:navigator.userAgent,conversationId:U||void 0,actor:{id:D.user.id,role:z.role},requestedTools:u},{accessToken:D.access_token});if(a.conversationId&&(localStorage.setItem("chatConversationId",a.conversationId),j(a.conversationId),x.debug("Persisted chat conversation identifier after assistant response")),t(b=>[...b.slice(0,-1),{role:"assistant",content:a.response,status:a.action?"processing":"complete"}]),a.action){x.info("Executing chat bot action",{metadata:{actionType:a.action.type}});const b=a.action.type;try{switch(a.action.type){case"cancel_sessions":{const{date:r,reason:o,therapist_id:f}=a.action.data;if(!r)throw new Error("Cancellation requests must include a date");const d=typeof o=="string"&&o.trim().length>0?o:"Staff development day";t(l=>[...l.slice(0,-1),{role:"assistant",content:`${a.response}

⏳ Cancelling sessions...`,status:"processing"}]);try{const l=await Ie({date:r,therapistId:f,reason:d});await C.invalidateQueries({queryKey:["sessions"]});const y=[];l.cancelledCount>0&&y.push(`${l.cancelledCount} session${l.cancelledCount===1?"":"s"} cancelled`),l.alreadyCancelledCount>0&&y.push(`${l.alreadyCancelledCount} already cancelled`),l.totalCount===0&&y.push("no sessions found");const v=y.length>0?y.join(", "):"No matching sessions to cancel";E(v);const V=new Date(`${r}T00:00:00`).toLocaleDateString(),w=[a.response,"",l.totalCount===0?"ℹ️ No sessions matched the request.":`✅ ${l.cancelledCount} session${l.cancelledCount===1?"":"s"} cancelled for ${V}.`,l.alreadyCancelledCount>0?`ℹ️ ${l.alreadyCancelledCount} session${l.alreadyCancelledCount===1?"":"s"} were already cancelled.`:null,d?`Reason noted: ${d}`:null].filter(P=>!!P).join(`

`);t(P=>[...P.slice(0,-1),{role:"assistant",content:w,status:"action_success"}])}catch(l){throw x.error("Session cancellation workflow failed",{error:l,context:{component:"ChatBot",operation:"cancel_sessions"}}),l}break}case"schedule_session":{const r=a.action.data;localStorage.setItem("pendingSchedule",JSON.stringify(r)),document.dispatchEvent(new CustomEvent("openScheduleModal",{detail:r})),M("/schedule");break}case"modify_session":{const{session_id:r,...o}=a.action.data;t(d=>[...d.slice(0,-1),{role:"assistant",content:a.response+`

⏳ Updating session...`,status:"processing"}]);const{error:f}=await I.from("sessions").update(o).eq("id",r);if(f)throw f;await C.invalidateQueries({queryKey:["sessions"]}),E("Session updated successfully"),t(d=>[...d.slice(0,-1),{role:"assistant",content:a.response+`

✅ Session has been updated.`,status:"complete"}]);break}case"create_client":{t(o=>[...o.slice(0,-1),{role:"assistant",content:a.response+`

⏳ Creating client profile...`,status:"processing"}]);const{error:r}=await I.from("clients").insert([a.action.data]).select().single();if(r)throw r;await C.invalidateQueries({queryKey:["clients"]}),E("Client created successfully"),t(o=>[...o.slice(0,-1),{role:"assistant",content:a.response+`

✅ Client profile has been created.`,status:"complete"}]);break}case"update_client":{const{client_id:r,...o}=a.action.data;t(d=>[...d.slice(0,-1),{role:"assistant",content:a.response+`

⏳ Updating client profile...`,status:"processing"}]);const{error:f}=await I.from("clients").update(o).eq("id",r);if(f)throw f;await C.invalidateQueries({queryKey:["clients"]}),E("Client updated successfully"),t(d=>[...d.slice(0,-1),{role:"assistant",content:a.response+`

✅ Client profile has been updated.`,status:"complete"}]);break}case"create_therapist":{t(o=>[...o.slice(0,-1),{role:"assistant",content:a.response+`

⏳ Creating therapist profile...`,status:"processing"}]);const{error:r}=await I.from("therapists").insert([a.action.data]).select().single();if(r)throw r;await C.invalidateQueries({queryKey:["therapists"]}),E("Therapist created successfully"),t(o=>[...o.slice(0,-1),{role:"assistant",content:a.response+`

✅ Therapist profile has been created.`,status:"complete"}]);break}case"update_therapist":{const{therapist_id:r,...o}=a.action.data;t(d=>[...d.slice(0,-1),{role:"assistant",content:a.response+`

⏳ Updating therapist profile...`,status:"processing"}]);const{error:f}=await I.from("therapists").update(o).eq("id",r);if(f)throw f;await C.invalidateQueries({queryKey:["therapists"]}),E("Therapist updated successfully"),t(d=>[...d.slice(0,-1),{role:"assistant",content:a.response+`

✅ Therapist profile has been updated.`,status:"complete"}]);break}case"create_authorization":{t(l=>[...l.slice(0,-1),{role:"assistant",content:a.response+`

⏳ Creating authorization...`,status:"processing"}]);const{services:r,...o}=a.action.data,{data:f,error:d}=await I.from("authorizations").insert([o]).select().single();if(d)throw d;if(r&&r.length>0){const{error:l}=await I.from("authorization_services").insert(r.map(y=>({...y,authorization_id:f.id})));if(l)throw l}await C.invalidateQueries({queryKey:["authorizations"]}),E("Authorization created successfully"),t(l=>[...l.slice(0,-1),{role:"assistant",content:a.response+`

✅ Authorization has been created.`,status:"complete"}]);break}case"update_authorization":{const{authorization_id:r,services:o,...f}=a.action.data;t(l=>[...l.slice(0,-1),{role:"assistant",content:a.response+`

⏳ Updating authorization...`,status:"processing"}]);const{error:d}=await I.from("authorizations").update(f).eq("id",r);if(d)throw d;if(o&&o.length>0)for(const l of o){const{service_id:y,...v}=l,{error:V}=await I.from("authorization_services").update(v).eq("id",y);if(V)throw V}await C.invalidateQueries({queryKey:["authorizations"]}),E("Authorization updated successfully"),t(l=>[...l.slice(0,-1),{role:"assistant",content:a.response+`

✅ Authorization has been updated.`,status:"complete"}]);break}case"initiate_client_onboarding":{const{client_name:r,client_email:o,date_of_birth:f,insurance_provider:d,referral_source:l,service_preference:y}=a.action.data;t(w=>[...w.slice(0,-1),{role:"assistant",content:a.response+`

⏳ Initiating client onboarding...`,status:"processing"}]);const v=new URLSearchParams;if(r){const w=r.split(" ");w.length>0&&v.append("first_name",w[0]),w.length>1&&v.append("last_name",w.slice(1).join(" "))}o&&v.append("email",o),f&&v.append("date_of_birth",f),d&&v.append("insurance_provider",d),l&&v.append("referral_source",l),y&&Array.isArray(y)&&v.append("service_preference",y.join(","));const V=`/clients/new?${v.toString()}`;t(w=>[...w.slice(0,-1),{role:"assistant",content:a.response+`

✅ Client onboarding initiated. You can complete the process by clicking the link below.`,status:"complete"}]),window.open(V,"_blank");break}}}catch(r){x.error("Chat bot action execution failed",{error:r,context:{component:"ChatBot",operation:b}}),q(r),r instanceof Error&&B.trackAIError(r,{functionCalled:`ChatBot_${a.action?.type}`,errorType:"function_error"}),t(o=>[...o.slice(0,-1),{role:"assistant",content:a.response+`

❌ Error: `+(r instanceof Error?r.message:"Unable to complete the requested action. Please try again or use the manual interface."),status:"action_failed"}])}}}catch(u){if(u instanceof T){const b="You do not have permission to run that assistant command. Please contact an administrator if you believe this is a mistake.";x.warn("Assistant request blocked by guardrail",{metadata:u.audit}),B.trackAIError(u,{functionCalled:"ChatBot_processMessage",errorType:"guardrail_violation",audit:u.audit}),t(r=>[...r.slice(0,-1),{role:"assistant",content:"I can't help with that request because it exceeds the permissions for your account.",status:"error"}]),g(b),q(b);return}x.error("Chat bot message processing failed",{error:u,context:{component:"ChatBot",operation:"handleSubmit"}});const a=u instanceof Error?u.message:"An error occurred";q(a),u instanceof Error&&B.trackAIError(u,{functionCalled:"ChatBot_processMessage",errorType:"invalid_response"}),t(b=>[...b.slice(0,-1),{role:"assistant",content:"I apologize, but I encountered an error while processing your request. Please try again or use the manual interface instead.",status:"error"}]),g("Unable to process your request. Please try again.")}finally{m(!1)}};return e.jsxDEV(e.Fragment,{children:[e.jsxDEV("button",{id:"chat-trigger",onClick:()=>s(!0),className:"hidden","aria-label":"Open chat assistant"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:726,columnNumber:7},this),n&&e.jsxDEV("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 p-4",children:e.jsxDEV("div",{className:"bg-white dark:bg-dark-lighter rounded-t-lg sm:rounded-lg shadow-xl w-full max-w-lg flex flex-col h-[80vh] sm:h-[600px]",children:[e.jsxDEV("div",{className:"flex items-center justify-between p-4 border-b dark:border-gray-700",children:[e.jsxDEV("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white flex items-center",children:[e.jsxDEV($,{className:"w-5 h-5 mr-2 text-blue-600"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:738,columnNumber:17},this),"AI Assistant"]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:737,columnNumber:15},this),e.jsxDEV("button",{onClick:()=>s(!1),className:"text-gray-400 hover:text-gray-500 dark:text-gray-500 dark:hover:text-gray-400",children:[e.jsxDEV("span",{className:"sr-only",children:"Close"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:745,columnNumber:17},this),e.jsxDEV("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsxDEV("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:752,columnNumber:19},this)},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:746,columnNumber:17},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:741,columnNumber:15},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:736,columnNumber:13},this),e.jsxDEV("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[i.length===0&&e.jsxDEV("div",{className:"text-center text-gray-500 dark:text-gray-400 py-8",children:[e.jsxDEV($,{className:"h-8 w-8 mx-auto mb-3 opacity-50","data-testid":"empty-state-icon"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:765,columnNumber:19},this),e.jsxDEV("p",{children:"Hi! I'm your scheduling assistant. How can I help you today?"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:769,columnNumber:19},this),e.jsxDEV("p",{className:"text-sm mt-2",children:"You can ask me about:"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:772,columnNumber:19},this),e.jsxDEV("ul",{className:"text-sm mt-1 space-y-1",children:[e.jsxDEV("li",{children:"• Scheduling new sessions"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:774,columnNumber:21},this),e.jsxDEV("li",{children:"• Canceling or modifying sessions"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:775,columnNumber:21},this),e.jsxDEV("li",{children:"• Managing clients and therapists"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:776,columnNumber:21},this),e.jsxDEV("li",{children:"• Handling authorizations"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:777,columnNumber:21},this),e.jsxDEV("li",{children:"• Onboarding new clients"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:778,columnNumber:21},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:773,columnNumber:19},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:764,columnNumber:17},this),i.map((N,_)=>e.jsxDEV("div",{className:`flex ${N.role==="user"?"justify-end":"justify-start"}`,children:e.jsxDEV("div",{className:`rounded-lg px-4 py-2 max-w-[80%] relative ${N.role==="user"?"bg-blue-600 text-white":"bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100"}`,children:[e.jsxDEV("div",{className:"whitespace-pre-wrap",children:N.content},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:794,columnNumber:21},this),N.status==="sending"&&e.jsxDEV("div",{className:"absolute -right-6 top-1/2 -translate-y-1/2",children:e.jsxDEV(Q,{className:"w-4 h-4 animate-spin text-blue-600"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:797,columnNumber:25},this)},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:796,columnNumber:23},this),N.status==="processing"&&e.jsxDEV("div",{className:"absolute -right-6 top-1/2 -translate-y-1/2",children:e.jsxDEV(Q,{className:"w-4 h-4 animate-spin text-yellow-600"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:802,columnNumber:25},this)},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:801,columnNumber:23},this),N.status==="action_success"&&e.jsxDEV("div",{className:"absolute -right-6 top-1/2 -translate-y-1/2",children:e.jsxDEV(ae,{className:"w-4 h-4 text-green-600"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:807,columnNumber:25},this)},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:806,columnNumber:23},this),N.status==="action_failed"&&e.jsxDEV("div",{className:"absolute -right-6 top-1/2 -translate-y-1/2",children:e.jsxDEV(re,{className:"w-4 h-4 text-red-600"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:812,columnNumber:25},this)},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:811,columnNumber:23},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:787,columnNumber:19},this)},_,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:783,columnNumber:17},this)),S&&e.jsxDEV("div",{className:"flex items-center justify-center text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 p-2 rounded-lg",children:[e.jsxDEV(ne,{className:"w-4 h-4 mr-2"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:820,columnNumber:19},this),S]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:819,columnNumber:17},this),e.jsxDEV("div",{ref:A},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:824,columnNumber:15},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:762,columnNumber:13},this),e.jsxDEV("form",{onSubmit:L,className:"p-4 border-t dark:border-gray-700",children:e.jsxDEV("div",{className:"flex space-x-4",children:[e.jsxDEV("input",{type:"text",value:p,onChange:N=>c(N.target.value),placeholder:"Type your message...",className:"flex-1 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:text-gray-200",disabled:h,"data-testid":"ai-chat-input"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:832,columnNumber:17},this),e.jsxDEV("button",{type:"submit",disabled:h||!p.trim(),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed","data-testid":"send-message",children:e.jsxDEV(oe,{className:"h-5 w-5"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:847,columnNumber:19},this)},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:841,columnNumber:17},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:831,columnNumber:15},this)},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:827,columnNumber:13},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:735,columnNumber:11},this)},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:734,columnNumber:9},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/ChatBot.tsx",lineNumber:725,columnNumber:5},this)}function qe(){const{signOut:n,hasRole:s,hasAnyRole:i,user:t,profile:p}=K(),{isDark:c,toggleTheme:h}=Ae(),[m,S]=k.useState(!1),[g,A]=k.useState(!1),[U,j]=k.useState(!1),C=ee(),M=s("therapist")||t?.user_metadata?.therapist_id,D=t?.user_metadata?.therapist_id,z=async()=>{if(!m)try{S(!0),await n(),C("/login",{replace:!0})}catch(u){x.error("Sidebar sign-out failed",{error:u,context:{component:"Sidebar",operation:"handleSignOut"},metadata:{hadUser:!!t,hadProfile:!!p,attemptedNavigate:!0}}),S(!1),C("/login")}},R=async()=>{if(!U){x.info("Manual session refresh requested",{context:{component:"Sidebar",operation:"refreshSession"},metadata:{hasProfile:!!p}});try{j(!0),x.debug("Manual session refresh acknowledged by auth context",{context:{component:"Sidebar",operation:"refreshSession"},metadata:{hasRole:!!p?.role}}),x.info("Manual session refresh completed",{context:{component:"Sidebar",operation:"refreshSession"},metadata:{therapistView:!!D}}),j(!1)}catch(u){x.error("Sidebar session refresh failed",{error:u,context:{component:"Sidebar",operation:"refreshSession"},metadata:{therapistView:!!D}}),j(!1)}}},L=[{icon:le,label:"Family",path:"/family",roles:["client"]},{icon:ce,label:"Dashboard",path:"/",roles:[]},{icon:F,label:"Schedule",path:"/schedule",roles:[]},{icon:me,label:"Clients",path:"/clients",roles:["therapist","admin","super_admin"]},{icon:de,label:"Therapists",path:"/therapists",roles:["admin","super_admin"]},{icon:ue,label:"Authorizations",path:"/authorizations",roles:["therapist","admin","super_admin"]},{icon:G,label:"Documentation",path:"/documentation",roles:[]},{icon:G,label:"Fill Docs",path:"/fill-docs",roles:["therapist","admin","super_admin"]},{icon:pe,label:"Billing",path:"/billing",roles:["admin","super_admin"]},{icon:he,label:"Reports",path:"/reports",roles:["admin","super_admin"]},{icon:be,label:"Monitoring",path:"/monitoring",roles:["admin","super_admin"]},{icon:fe,label:"Settings",path:"/settings",roles:["admin","super_admin"]}],N=()=>e.jsxDEV("button",{type:"button",onClick:()=>A(!g),className:"lg:hidden fixed top-4 left-4 z-50 p-2 rounded-lg bg-white dark:bg-dark-lighter shadow-lg border border-gray-200 dark:border-gray-700","aria-label":g?"Close navigation":"Open navigation","aria-expanded":g,"aria-controls":"app-sidebar",children:g?e.jsxDEV(ye,{"aria-hidden":"true",className:"h-6 w-6 text-gray-600 dark:text-gray-300"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:166,columnNumber:9},this):e.jsxDEV(ve,{"aria-hidden":"true",className:"h-6 w-6 text-gray-600 dark:text-gray-300"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:168,columnNumber:9},this)},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:157,columnNumber:5},this),_=i(["therapist","admin","super_admin"]);return e.jsxDEV(e.Fragment,{children:[e.jsxDEV(N,{},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:181,columnNumber:7},this),e.jsxDEV("aside",{id:"app-sidebar",className:`
        fixed lg:static inset-y-0 left-0 z-40
        w-64 bg-white dark:bg-dark-lighter border-r border-gray-200 dark:border-dark-border
        transform lg:transform-none transition-transform duration-200 ease-in-out
        ${g?"translate-x-0":"-translate-x-full lg:translate-x-0"}
        flex flex-col h-screen
      `,children:[e.jsxDEV("div",{className:"flex items-center p-6",children:[e.jsxDEV(F,{"aria-hidden":"true",className:"h-8 w-8 text-blue-600"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:191,columnNumber:11},this),e.jsxDEV("h1",{className:"ml-2 text-xl font-bold text-gray-900 dark:text-white",children:"AllIncompassing"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:192,columnNumber:11},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:190,columnNumber:9},this),e.jsxDEV("div",{className:"px-6 py-2 border-b border-gray-200 dark:border-gray-700",children:[e.jsxDEV("div",{className:"flex items-center mb-2",children:[e.jsxDEV(H,{"aria-hidden":"true",className:"h-5 w-5 text-gray-500 dark:text-gray-400 mr-2"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:198,columnNumber:13},this),e.jsxDEV("div",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 truncate",children:[e.jsxDEV("div",{children:t?.email},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:200,columnNumber:15},this),M&&D&&e.jsxDEV("div",{className:"text-xs text-blue-600 dark:text-blue-400",children:"Therapist Account"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:202,columnNumber:17},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:199,columnNumber:13},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:197,columnNumber:11},this),e.jsxDEV("div",{className:"flex items-center justify-between",children:[e.jsxDEV("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:["Role: ",p?.role||"No role assigned"]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:209,columnNumber:13},this),e.jsxDEV("button",{onClick:R,className:"text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 flex items-center",disabled:U,children:[e.jsxDEV(ie,{"aria-hidden":"true",className:`h-3 w-3 mr-1 ${U?"animate-spin":""}`},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:217,columnNumber:15},this),U?"Refreshing...":"Refresh"]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:212,columnNumber:13},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:208,columnNumber:11},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:196,columnNumber:9},this),M&&D&&e.jsxDEV("div",{className:"border-b dark:border-gray-700 px-4 py-2",children:e.jsxDEV(ke,{to:`/therapists/${D}`,className:"flex items-center w-full px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg transition-colors",children:[e.jsxDEV(H,{"aria-hidden":"true",className:"h-5 w-5 mr-3 text-blue-600 dark:text-blue-400"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:230,columnNumber:15},this),"My Profile"]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:226,columnNumber:13},this)},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:225,columnNumber:11},this),e.jsxDEV("nav",{className:"flex-1 space-y-1 px-4 py-4",children:L.map(({icon:u,label:a,path:b,roles:r})=>r.length>0&&!r.some(o=>s(o))?null:e.jsxDEV(Ce,{to:b,onClick:()=>A(!1),className:({isActive:o})=>`group inline-flex items-center px-6 py-4 border-b-2 font-medium text-sm
                  ${o?"border-blue-500 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300"}`,children:({isActive:o})=>e.jsxDEV(e.Fragment,{children:[e.jsxDEV(u,{"aria-hidden":"true",className:`
                        -ml-1 mr-2 h-5 w-5
                        ${o?"text-blue-500 dark:text-blue-400":"text-gray-400 group-hover:text-gray-500 dark:text-gray-500 dark:group-hover:text-gray-400"}
                      `},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:259,columnNumber:21},this),a]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:258,columnNumber:19},this)},b,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:244,columnNumber:15},this))},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:236,columnNumber:9},this),e.jsxDEV("div",{className:"mt-auto space-y-1 p-4",children:[_&&e.jsxDEV("button",{onClick:()=>{document.getElementById("chat-trigger")?.click(),A(!1)},className:"flex items-center w-full px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg transition-colors",children:[e.jsxDEV($,{"aria-hidden":"true",className:"h-5 w-5 mr-3"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:287,columnNumber:15},this),"Chat Assistant"]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:280,columnNumber:13},this),e.jsxDEV("button",{onClick:()=>{h(),A(!1)},className:"flex items-center w-full px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg transition-colors",children:[e.jsxDEV(ge,{"aria-hidden":"true",className:"h-5 w-5 mr-3 dark:hidden"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:299,columnNumber:13},this),e.jsxDEV(Ne,{"aria-hidden":"true",className:"h-5 w-5 mr-3 hidden dark:block"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:300,columnNumber:13},this),c?"Light Mode":"Dark Mode"]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:292,columnNumber:11},this),e.jsxDEV("button",{onClick:z,disabled:m,className:`flex items-center w-full px-4 py-2 rounded-lg transition-colors ${m?"bg-gray-100 dark:bg-gray-800 text-gray-400 dark:text-gray-500 cursor-not-allowed":"text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20"}`,children:[e.jsxDEV(xe,{"aria-hidden":"true",className:`h-5 w-5 mr-3 ${m?"animate-pulse":""}`},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:313,columnNumber:13},this),m?"Signing out...":"Sign Out"]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:304,columnNumber:11},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:278,columnNumber:9},this),_&&e.jsxDEV(ze,{},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:318,columnNumber:36},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:183,columnNumber:7},this),g&&e.jsxDEV("div",{className:"fixed inset-0 z-30 lg:hidden",children:e.jsxDEV("button",{type:"button","aria-label":"Close navigation overlay",className:"w-full h-full bg-black bg-opacity-50",onClick:()=>A(!1),onKeyDown:u=>{(u.key==="Enter"||u.key===" ")&&A(!1)}},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:324,columnNumber:11},this)},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:323,columnNumber:9},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Sidebar.tsx",lineNumber:180,columnNumber:5},this)}function Fe(){const{user:n,profile:s}=K();return e.jsxDEV("div",{className:"flex min-h-screen bg-gray-50 dark:bg-dark",children:[e.jsxDEV(qe,{},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Layout.tsx",lineNumber:11,columnNumber:7},this),e.jsxDEV("main",{className:"flex-1 p-4 lg:p-8 w-full lg:ml-64",children:[n&&e.jsxDEV("div",{className:"mb-4 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm",children:[e.jsxDEV("span",{className:"font-medium",children:"Logged in as:"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Layout.tsx",lineNumber:16,columnNumber:13},this)," ",n.email,e.jsxDEV("span",{className:"ml-2 font-medium",children:"Role:"},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Layout.tsx",lineNumber:17,columnNumber:13},this)," ",s?.role||"No role assigned"]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Layout.tsx",lineNumber:15,columnNumber:11},this),e.jsxDEV(De,{},void 0,!1,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Layout.tsx",lineNumber:20,columnNumber:9},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Layout.tsx",lineNumber:12,columnNumber:7},this)]},void 0,!0,{fileName:"C:/Users/test/Desktop/AllIincompassing/src/components/Layout.tsx",lineNumber:10,columnNumber:5},this)}export{Fe as default};
