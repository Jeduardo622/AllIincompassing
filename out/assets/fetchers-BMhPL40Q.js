import{f as o}from"./reports-B0fjwS8-.js";import{C as u}from"./select-CDRQddG6.js";const f=t=>{if(!t||typeof t!="object")return null;const e=t,a=typeof e.id=="string"?e.id:null,n=typeof e.full_name=="string"?e.full_name:typeof e.fullName=="string"?e.fullName:null;return!a&&!n?null:{id:a,fullName:n}},_=t=>{if(!t||typeof t!="object")return null;const e=t,a=typeof e.id=="string"?e.id:null,n=typeof e.start_time=="string"?e.start_time:null,r=typeof e.end_time=="string"?e.end_time:null,i=typeof e.status=="string"?e.status:null;return!a||!n||!r||!i?null:{id:a,startTime:n,endTime:r,status:i,therapist:f(e.therapist??e.therapist_summary??null)}},p=t=>{if(!t||typeof t!="object")return null;const e=t,a=typeof e.id=="string"?e.id:null;return a?{id:a,content:typeof e.content=="string"?e.content:null,createdAt:typeof e.created_at=="string"?e.created_at:null,status:typeof e.status=="string"?e.status:null,createdBy:typeof e.created_by=="string"?e.created_by:null,createdByName:typeof e.created_by_name=="string"?e.created_by_name:null}:null},y=t=>{const e=Array.isArray(t.upcoming_sessions)?t.upcoming_sessions:[],a=Array.isArray(t.guardian_notes)?t.guardian_notes:[],n=e.map(i=>_(i)).filter(i=>i!==null),r=a.map(i=>p(i)).filter(i=>i!==null);return{clientId:t.client_id,fullName:t.client_full_name,dateOfBirth:t.client_date_of_birth??null,email:t.client_email??null,phone:t.client_phone??null,status:t.client_status??null,relationship:t.guardian_relationship??null,isPrimaryGuardian:!!t.guardian_is_primary,upcomingSessions:n,notes:r}},m="full_name",C=async t=>{const{organizationId:e,client:a,allowAll:n=!1}=t;if(!n&&!e)throw new Error("organizationId is required to fetch clients");let i=(a??o).from("clients").select(u);if(e)i=i.eq("organization_id",e);else if(!n)throw new Error("organizationId is required to fetch clients");const{data:s,error:l}=await i.order(m,{ascending:!0});if(l)throw l;return s??[]},I=async(t,e,a=o)=>{if(!e)throw new Error("organizationId is required to fetch a client record");const{data:n,error:r}=await a.from("clients").select(u).eq("organization_id",e).eq("id",t).single();if(r)throw r;return n??null},N=async(t=o)=>{const{data:e,error:a}=await t.rpc("get_guardian_client_portal");if(a)throw a;return(e??[]).map(y)},g=t=>{const e=typeof t.id=="string"?t.id:null,a=typeof t.content=="string"?t.content:"",n=typeof t.created_at=="string"?t.created_at:null,r=typeof t.status=="string"?t.status:null,i=typeof t.created_by=="string"?t.created_by:null,s=!!t.is_visible_to_parent,l=!!(t.is_visible_to_therapist??!0);if(!e||!n)return null;const c=t.created_by_profile??null,d=typeof c?.full_name=="string"?c.full_name:null;return{id:e,content:a,createdAt:n,status:r,createdBy:i,createdByName:d,isVisibleToParent:s,isVisibleToTherapist:l}},E=async(t,e={},a=o)=>{const n=a.from("client_notes").select(`
        id,
        content,
        status,
        created_at,
        created_by,
        is_visible_to_parent,
        is_visible_to_therapist,
        created_by_profile:profiles!client_notes_created_by_fkey(full_name)
      `).eq("client_id",t).order("created_at",{ascending:!1});e.visibleToParentOnly&&n.eq("is_visible_to_parent",!0);const{data:r,error:i}=await n;if(i)throw i;return(r??[]).map(s=>g(s)).filter(s=>s!==null)},h=t=>{const e=typeof t.id=="string"?t.id:null;if(!e)return null;const a=typeof t.category=="string"?t.category:null,n=typeof t.description=="string"?t.description:null,r=typeof t.status=="string"?t.status:null,i=typeof t.priority=="string"?t.priority:null,s=typeof t.date_opened=="string"?t.date_opened:null,l=typeof t.last_action=="string"?t.last_action:null;return{id:e,category:a,description:n,status:r,priority:i,dateOpened:s,lastAction:l}},A=async(t,e=o)=>{const{data:a,error:n}=await e.from("client_issues").select("*").eq("client_id",t).order("created_at",{ascending:!1});if(n){if(n.code==="42P01")return[];if(typeof n.message=="string"&&n.message.includes("client_issues"))return[];throw n}return(a??[]).map(r=>h(r)).filter(r=>r!==null)},B=async(t,e,a=o)=>{const n=new Date().toISOString(),{data:r,error:i}=await a.from("client_guardians").select("id, metadata").eq("guardian_id",t).eq("client_id",e).is("deleted_at",null).maybeSingle();if(i)throw i;if(!r)throw new Error("Guardian link not found for confirmation");const l={...r.metadata??{},last_confirmed_at:n},{data:c,error:d}=await a.from("client_guardians").update({metadata:l}).eq("id",r.id).select("metadata").single();if(d)throw d;return{confirmedAt:n,metadata:c?.metadata??l}},T=async(t,e=o)=>{const{data:a,error:n}=await e.rpc("guardian_contact_metadata",{p_guardian_id:t});if(n)throw n;return(a??[]).map(r=>{const i=r,s=typeof i.client_id=="string"?i.client_id:"",l=i.metadata??{};return{clientId:s,metadata:l}}).filter(r=>!!r.clientId)};export{I as a,N as b,B as c,E as d,A as e,C as f,T as g};
