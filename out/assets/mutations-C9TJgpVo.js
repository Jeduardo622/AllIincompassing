import{l as n,t as c,r as l,q as o}from"./reports-B0fjwS8-.js";const d=t=>t.replace(/[%_]/g,r=>`\\${r}`),f=async(t,r)=>{const e=d(r),{data:a,error:i}=await t.from("clients").select("id").ilike("email",e).limit(1);if(i)throw i;return Array.isArray(a)&&a.length>0},w=async(t,r)=>{const e=r.trim().toLowerCase();if(!e)return!1;const{data:a,error:i}=await t.rpc("client_email_exists",{p_email:e});if(!i)return!!a;l(i,"client_email_exists")||n.warn("Client email uniqueness RPC failed; attempting fallback query",{error:c(i,"client_email_exists RPC failed"),metadata:{normalizedEmail:e},track:!1});try{return await f(t,e)}catch(s){return n.error("Client email uniqueness fallback failed",{error:c(s,"Client email fallback failed"),metadata:{normalizedEmail:e},track:!1}),!1}},m=async(t,r)=>{const{data:e,error:a}=await t.from("clients").insert(r).select().single();if(a)throw a;if(!e)throw new Error("Client insert succeeded without returning data");return e},u=async(t,r)=>{const{data:e,error:a}=await t.rpc("create_client",{p_client_data:r});return{data:e??null,error:a}},k=async(t,r)=>{const e=await u(t,r);if(!e.error){if(e.data)return e.data;const a=new Error("create_client RPC returned no data");throw n.error("create_client RPC did not return a client record",{error:c(a,"create_client RPC returned no data"),metadata:{providedFields:Object.keys(r)},track:!1}),a}if(!l(e.error,"create_client"))throw n.error("create_client RPC failed",{error:c(e.error,o(e.error)),metadata:{providedFields:Object.keys(r)},track:!1}),e.error;n.warn("create_client RPC missing; attempting direct insert fallback",{metadata:{providedFields:Object.keys(r)},track:!1});try{return await m(t,r)}catch(a){throw n.error("Client insert fallback failed",{error:c(a,"Client insert fallback failed"),metadata:{providedFields:Object.keys(r)},track:!1}),a}},C=async(t,r)=>{const{error:e}=await t.rpc("update_client_documents",{p_client_id:r.clientId,p_documents:r.documents});if(e)throw e};export{w as a,k as c,C as u};
