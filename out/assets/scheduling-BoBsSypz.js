import{e as tt}from"./maps-DwSjqVUD.js";import{b as B,c as K,f as F,d as v,g as et,p as w,i as V,h as b,j as nt}from"./dates-C30WUoI7.js";const D={latitude:40.7128,longitude:-74.006},rt=.1,N=new Map,st=2166136261,ot=16777619,P=t=>t?t.trim().replace(/\s+/g," ").toLowerCase():"",it=t=>{let e=st;for(let n=0;n<t.length;n+=1)e^=t.charCodeAt(n),e=Math.imul(e,ot)>>>0;return e>>>0},at=t=>t/4294967295,z=(t,e)=>(at(it(`${e}:${t}`))*2-1)*rt,H=t=>Number(t.toFixed(6)),ct=t=>{const e=P(t);if(!e)return null;const n=H(D.latitude+z(e,"lat")),s=H(D.longitude+z(e,"lon"));return{latitude:n,longitude:s,address:t.trim()}};let lt={enabled:!0,provider:ct};const ut=t=>P(t),dt=t=>{const e=typeof t=="string"?t.trim():"";if(!e)return null;const n=ut(e);if(N.has(n)){const o=N.get(n);return o?{latitude:o.latitude,longitude:o.longitude,address:e}:null}const s=lt.provider(e);if(!s)return N.set(n,null),null;const r={latitude:H(s.latitude),longitude:H(s.longitude)};return N.set(n,r),{latitude:r.latitude,longitude:r.longitude,address:s.address??e}},$=new Map;function A(t,e){return((...n)=>{const s=e(...n);if($.has(s))return $.get(s);const r=t(...n);return $.set(s,r),r})}const mt={MAX_DAILY_HOURS:8},I={COMPATIBILITY:.25,AVAILABILITY:.2,WORKLOAD:.15,TRAVEL_TIME:.15,CONTINUITY:.1,URGENCY:.1,EFFICIENCY:.05},gt={latitude:40.7128,longitude:-74.006,address:"therapist_base_location"},G=60;function R(t){return t==null?null:Number.isFinite(t)?Math.max(0,Number(t)):null}function ft(t){const e=R(t.authorized_hours_per_month??null),n=R(t.hours_provided_per_month??0)??0,s=R(t.unscheduled_hours??null);let r=null;if(e!==null){const o=Math.min(n,e);r=Math.max(e-o,0)}return s!==null&&(r===null?r=s:r=Math.min(r,s)),{authorizedHours:e,providedHours:n,unscheduledHours:s,remainingHours:r,remainingMinutes:r===null?null:r*G}}const X=A(t=>{if(!t.address)return null;const e=dt(t.address);return e?{latitude:e.latitude,longitude:e.longitude,address:e.address??t.address.trim()}:null},t=>`location_${t.address?.trim().toLowerCase()??"unknown"}`),ht=A((t,e,n)=>{const s=tt.getDistance({latitude:t.latitude,longitude:t.longitude},{latitude:e.latitude,longitude:e.longitude}),r=n.getHours(),d=r>=7&&r<=9||r>=16&&r<=18?25:35,c=Math.ceil(s/1e3/d*60);return{distance:s,duration:c}},(t,e,n)=>{const s=t.address?.trim().toLowerCase()??`${t.latitude}_${t.longitude}`,r=e.address?.trim().toLowerCase()??`${e.latitude}_${e.longitude}`;return`travel_${s}_${r}_${n.getHours()}`}),pt=A((t,e)=>{let n=0;const s=e.service_preference||[],r=t.service_type||[],o=s.filter(l=>r.includes(l));if(o.length===0)return 0;n+=o.length/Math.max(s.length,r.length)*.4;const d=e.diagnosis||[],c=t.specialties||[];return d.some(l=>c.some(m=>m.toLowerCase().includes(l.toLowerCase())))&&(n+=.3),t.languages?.includes(e.preferred_language||"English")&&(n+=.2),(t.years_experience||0)>=3&&(n+=.1),Math.min(n,1)},(t,e)=>`compatibility_${t.id}_${e.id}`),_t=A((t,e,n,s,r)=>{const o=F(t,"EEEE").toLowerCase();let d=0;const c=n.availability_hours?.[o];if(!c?.start||!c?.end)return 0;const[u]=c.start.split(":").map(Number),[h]=c.end.split(":").map(Number),l=t.getHours(),m=e.getHours();if(l<u||m>h)return 0;const g=s.availability_hours?.[o];if(!g?.start||!g?.end)return 0;const[O]=g.start.split(":").map(Number),[k]=g.end.split(":").map(Number);if(l<O||m>k||r.some(L=>{const y=w(L.start_time),S=w(L.end_time);return V(t,y)&&(L.therapist_id===n.id||L.client_id===s.id)?b(t,{start:y,end:S})||b(e,{start:y,end:S})||b(y,{start:t,end:e}):!1}))return 0;const a=9,p=15,f=Math.abs(l-a),_=Math.abs(m-p);return d=Math.max(0,1-(f+_)/10),d},(t,e,n,s)=>`availability_${t.toISOString()}_${e.toISOString()}_${n.id}_${s.id}`),St=A((t,e,n)=>{const s=B(e),r=K(e),c=n.filter(l=>{const m=w(l.start_time);return l.therapist_id===t.id&&b(m,{start:s,end:r})}).reduce((l,m)=>{const g=w(m.start_time),O=w(m.end_time);return l+nt(O,g)},0)/60,u=(t.weekly_hours_min+t.weekly_hours_max)/2,h=u-c;return h<=0||c>=mt.MAX_DAILY_HOURS?0:Math.min(h/u,1)},(t,e)=>`workload_${t.id}_${e.toISOString()}`),Mt=A((t,e,n,s)=>{const r=X(e);if(!r)return .5;const o=s.filter(u=>u.therapist_id===t.id&&V(w(u.start_time),n)).sort((u,h)=>new Date(u.start_time).getTime()-new Date(h.start_time).getTime());if(o.length===0)return 1;o[o.length-1];const d=gt,{duration:c}=ht(d,r,n);return Math.max(0,1-c/60)},(t,e,n)=>`travel_${t.id}_${e.id}_${n.toISOString()}`),yt=()=>.5,Et=()=>.5,It=()=>.5;function At(t,e,n,s,r,o=60){const d=[],c=new Map,u=new Map,h=new Map,l=(i,a)=>{const p=Math.max(0,a),f=h.get(i.id);(!f||p<f.remainingMinutes)&&h.set(i.id,{client:i,remainingMinutes:p})};e.forEach(i=>{const a=ft(i);u.set(i.id,a.remainingMinutes),a.remainingMinutes!==null&&a.remainingMinutes<o&&l(i,a.remainingMinutes)});const m=t.flatMap(i=>e.map(a=>({therapist:i,client:a,baseScore:pt(i,a)}))).filter(i=>i.baseScore>0).sort((i,a)=>a.baseScore-i.baseScore);let g=new Date(s);for(;g<=r;){const i=B(g,{weekStartsOn:1}),a=K(g,{weekStartsOn:1}),p=F(i,"yyyy-MM-dd");c.has(p)||c.set(p,{therapistMinutes:new Map,clientMinutes:new Map});const f=c.get(p);let _=new Date(i);for(;_<=a&&_<=r;){if(F(_,"EEEE").toLowerCase()==="sunday"){_=v(_,1);continue}for(let y=8;y<18;y++)for(const{therapist:S,client:M,baseScore:j}of m){const x=f.therapistMinutes.get(S.id)||0,q=f.clientMinutes.get(M.id)||0,J=S.weekly_hours_max*G;if(x+o>J)continue;const E=u.get(M.id);if(E!=null&&E<o){l(M,E);continue}const C=new Date(_);C.setHours(y,0,0,0);const Y=et(C,o),U=_t(C,Y,S,M,n);if(U===0)continue;const Q=St(S,C,n),Z=Mt(S,M,C,n),W=j*I.COMPATIBILITY+U*I.AVAILABILITY+Q*I.WORKLOAD+Z*I.TRAVEL_TIME+yt()*I.CONTINUITY+Et()*I.URGENCY+It()*I.EFFICIENCY;if(W>.3){if(d.push({therapist:S,client:M,startTime:C.toISOString(),endTime:Y.toISOString(),score:W,location:X(M)}),f.therapistMinutes.set(S.id,x+o),f.clientMinutes.set(M.id,q+o),E!=null){const T=Math.max(E-o,0);u.set(M.id,T),T<o&&l(M,T)}break}}_=v(_,1)}g=v(g,7)}const O=d.sort((i,a)=>a.score-i.score).slice(0,100),k=Array.from(h.values()).sort((i,a)=>{const p=i.client.full_name?.toLowerCase()||"",f=a.client.full_name?.toLowerCase()||"";return p===f?i.client.id.localeCompare(a.client.id):p.localeCompare(f)});return{slots:O,cappedClients:k}}export{At as g};
