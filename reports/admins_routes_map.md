# Admins Route Map

| Route/Function | Method | Path/File | Purpose | Auth Required | Headers (Auth/apikey) | Handler | Notes |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `/admin/users` | GET | `supabase/functions/admin-users/index.ts` | Lists admin users for a specific organization with pagination and search. | `createProtectedRoute` + `assertAdminOrSuperAdmin`; requires organization UUID query param. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export handler. | Fetches all admins via `get_admin_users` RPC then paginates in-memory; logs and maps 403 from RPC; exposes filters and pagination metadata.【F:supabase/functions/admin-users/index.ts†L1-L94】 |
| `/admin/users/:id/roles` | PATCH | `supabase/functions/admin-users-roles/index.ts` | Updates a user's role/active status and logs admin action. | Authenticated via `assertAdminOrSuperAdmin`; super-admin route option. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export handler. | Validates UUID path segment and payload role enum; prevents self-demotion for super admins; inserts audit row into `admin_actions`.【F:supabase/functions/admin-users-roles/index.ts†L1-L78】 |
| `/admin/invite` | POST | `supabase/functions/admin-invite/index.ts` | Issues admin/super-admin invitation tokens and triggers email service. | `createProtectedRoute` requiring admin or super admin; enforces Zod payload. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export route. | Validates expiration window, deduplicates invites via hashed token, logs via `logApiAccess`; relies on env config for email base URL.【F:supabase/functions/admin-invite/index.ts†L1-L118】 |
| `/generate-report` | POST | `supabase/functions/generate-report/index.ts` | Generates aggregate admin reports (revenue, sessions) asynchronously. | Uses `createProtectedRoute`; admin/super-admin access enforced downstream. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export handler. | Accepts `reportType` and date range, enqueues tasks and returns signed URL; potential long-running job with asynchronous email send.【F:supabase/functions/generate-report/index.ts†L1-L120】 |
| `/get-dashboard-data` | POST | `supabase/functions/get-dashboard-data/index.ts` | Aggregates dashboard metrics (sessions, revenue, authorizations) for admin UI. | `createProtectedRoute` + session validation. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export handler. | Accepts `organizationId`, `dateRange`, and filter options; executes multiple RPCs and cached queries; heavy join set may require indexes.【F:supabase/functions/get-dashboard-data/index.ts†L1-L120】 |

## Security Risks
- `admin-users` still relies on RPC returning entire roster before pagination; a large org could exhaust memory or leak data if RPC ignores org_id.
- Role updates fetch auth-admin metadata using service role; failure paths log stack traces containing user metadata to console.
- Report/dashboard routes accept caller-provided organization IDs without cross-check beyond RPC, so any RLS regression would expose multi-tenant metrics.
