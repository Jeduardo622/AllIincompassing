# Clients Route Map

| Route/Function | Method | Path/File | Purpose | Auth Required | Headers (Auth/apikey) | Handler | Notes |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `/api/book` | POST | `src/server/api/book.ts` | Accepts booking payloads and forwards to `bookSession` orchestration. | Requires Supabase session token; rejects missing/empty `Authorization`. | `Authorization: Bearer <JWT>`, optional `Idempotency-Key`. | `bookHandler` | OPTIONS handled for CORS; trusts downstream RLS for org scoping and surfaces raw error messages on failure.【F:src/server/api/book.ts†L10-L86】 |
| `/get-client-details` | POST | `supabase/functions/get-client-details/index.ts` | Returns enriched client profile for roster/detail screens. | Protected via `createProtectedRoute`; enforces role/org checks through `user_has_role_for_org`. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | `handleGetClientDetails` via Deno serve export. | Distinguishes therapist/admin/client roles and blocks archived records for non-admins; logs audit events via `logApiAccess`.【F:supabase/functions/get-client-details/index.ts†L1-L132】 |
| `/initiate-client-onboarding` | POST | `supabase/functions/initiate-client-onboarding/index.ts` | Generates onboarding deep link for new clients based on admin-supplied metadata. | Requires authenticated Supabase session (`getUserOrThrow`). | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Inline `Deno.serve` handler. | Constructs redirect URL with query params and emits 400 on validation failure; no org re-check beyond caller’s session.【F:supabase/functions/initiate-client-onboarding/index.ts†L1-L84】 |
| `/profiles/me` | GET/PUT | `supabase/functions/profiles-me/index.ts` | Fetches/updates caller profile preferences, phone, timezone. | Guarded by `createProtectedRoute`; requires authenticated user. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export from `createProtectedRoute`. | GET returns sanitized profile; PUT validates allowed keys plus phone/timezone regex; writes via anon Supabase client.【F:supabase/functions/profiles-me/index.ts†L1-L120】 |
| `/get-dropdown-data` | GET | `supabase/functions/get-dropdown-data/index.ts` | Supplies client/therapist dropdown data for scheduling forms. | Calls `getUserOrThrow`; no extra role filter. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Inline `Deno.serve` handler. | Supports query params for dataset selection; fetches active clients/therapists with `deleted_at` filter but omits explicit org scoping.【F:supabase/functions/get-dropdown-data/index.ts†L1-L70】 |

## Security Risks
- `/initiate-client-onboarding` only checks caller authentication; absence of org validation could let cross-tenant admins mint onboarding URLs if role policies weaken.
- `/get-dropdown-data` returns entire client roster for the caller’s project with no org_id filtering; relies entirely on RLS to prevent cross-tenant leakage.
- `/api/book` trusts caller timestamps and only uses JWT presence; if JWT is replayed from another org, incorrect sessions could be queued without secondary verification.
