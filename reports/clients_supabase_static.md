# Clients Supabase Static Review

| Object | Type | Key Columns / Indexes | Policies / Grants | Notes |
| --- | --- | --- | --- | --- |
| `public.clients` | Table | Columns include `organization_id`, `deleted_at`, `deleted_by`, `availability_hours`, `service_preference`; indexes on `(organization_id, deleted_at)` and `(organization_id, status)` support archive/status filters.【F:supabase/migrations/20251101100000_soft_delete_archival.sql†L1-L20】【F:supabase/migrations/20251015121500_dashboard_org_indexes.sql†L18-L24】 | Row policies require admin/super-admin ownership or therapist link via `app.user_has_role_for_org`; archived rows excluded from therapist reads.【F:supabase/migrations/20251101100000_soft_delete_archival.sql†L120-L156】 | Browser Supabase client queries this table directly; any RLS regression leaks cross-tenant roster data. |
| `app.set_client_archive_state` | Function (SECURITY DEFINER) | `(p_client_id uuid, p_restore boolean default false)` toggles `deleted_at/deleted_by`, returns updated row, updates audit timestamps.【F:supabase/migrations/20251101100000_soft_delete_archival.sql†L158-L210】 | `EXECUTE` granted to `authenticated`; verifies caller has admin/super-admin role for client org. | Invoked from React `Clients` page for archive/restore; definer privileges bypass RLS so guard logic must remain intact. |
| `app.user_has_role_for_org` | Function (SECURITY DEFINER) | Resolves organization for target client/session/therapist using metadata fallback logic.【F:supabase/migrations/20250923121500_enforce_org_scope.sql†L229-L310】 | `EXECUTE` granted to `authenticated`; central to all RLS. | If metadata lacks `organization_id`, function returns `false`, blocking legitimate access but preventing cross-tenant leakage. |
| `public.sessions` | Table | Composite indexes on `(organization_id, therapist_id)`, `(organization_id, client_id)`, `(organization_id, start_time)` improve schedule queries.【F:supabase/migrations/20251015121500_dashboard_org_indexes.sql†L12-L24】 | Policy `Sessions scoped access` gates all actions to role/org matches via `user_has_role_for_org` and therapist equality.【F:supabase/migrations/20250923121500_enforce_org_scope.sql†L713-L740】 | Heavy schedule queries still rely on RLS; ensure indexes remain in place when altering schema. |

## Security Observations
- Because `app.set_client_archive_state` is definer-level, failing to log or audit updates could hide malicious restores/deletes; consider triggers writing to audit tables.
- `user_has_role_for_org` depends on metadata stored in `auth.users`; stale metadata could block legitimate access or allow cross-org reads if mutated incorrectly.
- `sessions` table is widely queried with anon client; ensure all policies include `deleted_at IS NULL` to prevent exposing archived clients via join leakage.
