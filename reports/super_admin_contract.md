# Super Admin API Contracts & Validation

| Route | Request Schema | Response Schema | Status Codes | Validation Gaps |
| --- | --- | --- | --- | --- |
| `/super-admin/impersonate` | POST JSON: `{ action: 'issue'|'revoke', targetUserId?, targetUserEmail?, expiresInMinutes?, reason }`. | Issue: `{ success: true, token, expiresAt, auditId }`; Revoke: `{ success: true }`; Errors: `{ error }`. | 200 success, 400 invalid payload, 403 non-super-admin or cross-org denial, 404 target missing, 409 overlapping session, 500 failure. | Zod schema ensures minutes range but allows either ID or email; reason not strictly required for revoke; audit insert failures logged but do not abort. |【F:supabase/functions/super-admin-impersonate/index.ts†L14-L120】|
| `/super-admin/feature-flags` | POST JSON with `action` among `list`, `createFlag`, `updateGlobalFlag`, `setOrgFlag`, `setOrgPlan`, `upsertOrganization`. Each action has dedicated payload: e.g., `createFlag` needs `{ flagKey, description?, defaultEnabled? }`. | Success: `{ data: {...}, message? }` depending on action; Errors: `{ error, details? }`. | 200 success, 400 invalid JSON/action payload, 403 unauthorized, 409 duplicate slug, 500 on DB failure. | Schema ensures uuid/slug formatting but `organization.metadata` accepts arbitrary objects; no rate limits, so repeated toggles possible. |【F:supabase/functions/feature-flags/index.ts†L24-L88】|
| `/assign-therapist-user` | POST `{ userId: string, therapistId: string }`. | `{ action: 'updated'|'created', client, previousTherapistId? }` or `{ error }`. | 200 success, 400 missing params or archived therapist, 401 missing admin context, 403 cross-org, 404 missing user/therapist, 405 wrong method, 500 failure. | Organization comparison depends on metadata keys; absence of `organization_id` prevents assignment even for valid cross-tenant support cases. |【F:supabase/functions/assign-therapist-user/index.ts†L18-L100】|
| `/get-authorization-details` | POST `{ authorizationId: string }`. | `{ authorization: {...client, provider, services} }` or `{ error }`. | 200 success, 204 OPTIONS, 400 missing ID or DB error, 500 fallback. | No UUID check; returns raw nested objects including service details, exposing PHI if RLS misconfigured. |【F:supabase/functions/get-authorization-details/index.ts†L8-L24】|

## Security Risks
- Impersonation tokens minted with service role and returned to caller; without short TTL enforcement on revoke, sessions persist until expiry.
- Feature flag payloads allow plan reassignment without concurrency guard, risking overwritten plan metadata during simultaneous edits.
- Assignment endpoint uses Supabase admin API with service role; logging includes full error strings potentially leaking emails in logs.
