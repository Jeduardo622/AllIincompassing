# Super Admin Route Map

| Route/Function | Method | Path/File | Purpose | Auth Required | Headers (Auth/apikey) | Handler | Notes |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `/super-admin/impersonate` | POST | `supabase/functions/super-admin-impersonate/index.ts` | Issues and revokes audited impersonation tokens for cross-tenant troubleshooting. | `createProtectedRoute` enforces `super_admin` role and reason payload. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export handler. | Validates impersonation duration, target user (by ID or email), inserts `impersonation_audit` rows, and signs JWT with reduced TTL.【F:supabase/functions/super-admin-impersonate/index.ts†L1-L120】 |
| `/super-admin/feature-flags` | POST | `supabase/functions/feature-flags/index.ts` | Manages global and per-organization feature flags and plan assignments. | `createProtectedRoute` with `RouteOptions.superAdmin`. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export handler. | Parses `action` via Zod, normalizes slugs, and writes to `feature_flags`/`organization_feature_flags`; returns structured errors for invalid JSON.【F:supabase/functions/feature-flags/index.ts†L1-L88】 |
| `/assign-therapist-user` | POST | `supabase/functions/assign-therapist-user/index.ts` | Allows admins/super admins to associate Supabase auth users with therapist records. | `createProtectedRoute` + `assertAdminOrSuperAdmin`. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export route. | Pulls caller org from metadata, guards against cross-org assignments, and uses service role for auth lookups; rejects archived therapists.【F:supabase/functions/assign-therapist-user/index.ts†L1-L94】 |
| `/get-authorization-details` | POST | `supabase/functions/get-authorization-details/index.ts` | Surfaces detailed authorization + client/provider info for oversight dashboards. | `getUserOrThrow` ensures authentication; no extra role gating. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Inline `Deno.serve` handler. | Accepts `authorizationId` JSON payload; returns 400 on errors and logs message, relying on RLS for tenant isolation.【F:supabase/functions/get-authorization-details/index.ts†L1-L26】 |

## Security Risks
- Impersonation handler signs JWTs using service role credentials; audit log inserts are best-effort—failures fall back to console logging, so consider wrapping in transaction.
- Feature-flag action parser allows arbitrary metadata objects; absence of JSON schema for `organization.metadata` could write malformed data consumed elsewhere.
- `assign-therapist-user` relies on metadata-based org extraction; inconsistent metadata keys would bypass org comparison, risking cross-tenant assignments.
