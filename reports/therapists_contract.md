# Therapists API Contracts & Validation

| Route | Request Schema | Response Schema | Status Codes | Validation Gaps |
| --- | --- | --- | --- | --- |
| `/get-therapist-details` | POST `{ therapistId: string }`. | `{ therapist: {...therapist columns...} }` on success; `{ error: string }` on failure. | 200 success, 204 OPTIONS, 400 validation error, 500 fallback. | Only checks presence of `therapistId`; no UUID validation; catches errors generically exposing message strings. |【F:supabase/functions/get-therapist-details/index.ts†L7-L23】|
| `/get-schedule-data-batch` | GET query params or POST JSON with `start_date`, `end_date`, optional `therapist_ids[]`, `client_ids[]`, `batch_size`, `offset`, toggles. | `{ success: true, data: { sessions[], availability?, conflicts?, pagination, performance }, request_parameters, requestId }` or error envelope. | 200 success, 204 OPTIONS, 400 invalid payload, 429 rate-limited, 500 server error. | Zod schema ensures ranges but does not verify therapist/client IDs belong to caller; `requestId` resets when error thrown. |【F:supabase/functions/get-schedule-data-batch/index.ts†L18-L94】|
| `/get-sessions-optimized` | POST JSON with `organizationId`, optional `therapistIds[]`, `dateRange`, `includeTravelBuffer`, etc. | `{ data: { sessions, metrics }, pagination, meta }` or error payload. | 200 success, 400 invalid body, 401/403 when unauthorized, 429 via rate limit, 500 on failure. | Schema defined via Zod but uses `.uuid()` only for some fields; `organizationId` optional causing cross-tenant risk; travel buffer trust. |【F:supabase/functions/get-sessions-optimized/index.ts†L8-L120】|
| `/sessions/hold` | POST JSON: `{ therapistId, clientId, startTime, endTime, notes?, location? }`. | `{ holdId, expiresAt, conflicts[] }` or `{ error }`. | 200 success, 400 invalid payload/conflict, 403 unauthorized, 409 existing hold, 500 failure. | Validations rely on custom helper; concurrency controls not enforced beyond supabase row constraints. |【F:supabase/functions/sessions-hold/index.ts†L1-L120】|
| `/sessions/confirm` | POST JSON: `{ sessionId, confirmationCode?, overrideConflicts?, notifyClient? }`. | `{ session: {...}, authorization: {...?} }` or `{ error }`. | 200 success, 400 invalid body, 403 unauthorized, 404 missing session, 409 conflict, 500 failure. | Accepts boolean `overrideConflicts` without additional role gating; relies on SQL to reject unauthorized overrides. |【F:supabase/functions/sessions-confirm/index.ts†L20-L120】|
| `/suggest-alternative-times` | POST JSON: `{ therapistId, clientId?, startWindow, endWindow, durationMinutes, timezone }`. | `{ suggestions: [{ start, end, reason }], conflicts: [...] }` or `{ error }`. | 200 success, 400 invalid body, 500 server error. | No rate-limiting; timezone validated via Intl but errors return general message. |【F:supabase/functions/suggest-alternative-times/index.ts†L1-L100】|

## Security Risks
- Scheduling endpoints accept raw IDs; absent additional RPC checks, a compromised token can enumerate other tenants’ session metadata.
- `sessions-confirm` returns rich session payloads even on error, risking leakage if RLS misconfigured.
- Alternative time suggestions compute availability in memory and could leak other therapists’ open slots without verifying caller’s association.
