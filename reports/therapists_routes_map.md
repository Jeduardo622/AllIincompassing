# Therapists Route Map

| Route/Function | Method | Path/File | Purpose | Auth Required | Headers (Auth/apikey) | Handler | Notes |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `/get-therapist-details` | POST | `supabase/functions/get-therapist-details/index.ts` | Returns individual therapist profile for roster/detail screen. | Requires authenticated session via `getUserOrThrow`; no role restriction beyond membership. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Inline `Deno.serve` handler. | Lacks explicit org scoping beyond RLS; emits 400 on missing ID or fetch failure and logs error to console.【F:supabase/functions/get-therapist-details/index.ts†L1-L23】 |
| `/get-schedule-data-batch` | GET/POST | `supabase/functions/get-schedule-data-batch/index.ts` | Streams session, availability, and conflict data for therapists across ranges. | `getUserOrThrow` plus rate-limiting; accepts both GET query params and POST JSON. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Inline `Deno.serve` handler. | Validates payload with Zod, paginates server-side, but relies on caller-supplied therapist/client IDs without cross-checking org ownership.【F:supabase/functions/get-schedule-data-batch/index.ts†L1-L94】 |
| `/get-sessions-optimized` | POST | `supabase/functions/get-sessions-optimized/index.ts` | Provides batched session schedules with travel buffers and metrics. | Guarded by `createProtectedRoute`; requires auth. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export (protected route). | Accepts filter params including organization_id but trusts caller-provided IDs; includes performance telemetry in response.【F:supabase/functions/get-sessions-optimized/index.ts†L1-L120】 |
| `/sessions/hold` | POST | `supabase/functions/sessions-hold/index.ts` | Places a hold on therapist availability slots. | `createProtectedRoute` ensures authenticated user; expects role validation in SQL. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export `createProtectedRoute` handler. | Checks overlapping sessions but does not double-check therapist org_id beyond RPC; logs hold events for auditing.【F:supabase/functions/sessions-hold/index.ts†L1-L120】 |
| `/sessions/confirm` | POST | `supabase/functions/sessions-confirm/index.ts` | Confirms provisional sessions for therapists/clients. | `createProtectedRoute` plus explicit payload validation. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export handler. | Validates confirm payload, updates sessions and authorizations, but lacks impersonation guard so admins can confirm on behalf of therapists if RLS allows.【F:supabase/functions/sessions-confirm/index.ts†L1-L140】 |
| `/suggest-alternative-times` | POST | `supabase/functions/suggest-alternative-times/index.ts` | Suggests alternate appointment times for therapists considering conflicts. | `createProtectedRoute` ensures caller auth; uses supabase service client for heavy queries. | `Authorization: Bearer <JWT>`, `apikey: <anon>`. | Default export route. | Accepts start/end/timezone filters; may expose available slots for therapists outside caller org if RLS misconfigured.【F:supabase/functions/suggest-alternative-times/index.ts†L1-L120】 |

## Security Risks
- Several scheduling endpoints accept therapist/client ID arrays without re-validating ownership, trusting Supabase RLS to reject cross-org combinations.
- `get-therapist-details` returns 400 on missing/invalid therapist IDs but logs full error messages, potentially leaking internal SQL details in logs.
- Hold/confirm flows operate via service-role operations inside RPCs; if those RPCs allow definer access, compromised sessions could escalate to schedule arbitrary appointments.
